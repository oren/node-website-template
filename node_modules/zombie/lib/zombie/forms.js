// Generated by CoffeeScript 1.3.1
var File, HTML, Mime, Path, UploadedFile, element, focus, _i, _len, _ref;

HTML = require("jsdom").dom.level3.html;

Path = require("path");

File = require("fs");

Mime = require("mime");

UploadedFile = function(filename) {
  var file;
  file = new String(Path.basename(filename));
  file.filename = filename;
  file.mime = Mime.lookup(filename);
  file.read = function() {
    return File.readFileSync(filename);
  };
  return file;
};

HTML.HTMLFormElement.prototype.submit = function(button) {
  var document, params, process,
    _this = this;
  document = this.ownerDocument;
  params = [];
  process = function(index) {
    var field, history, name, option, selected, value, _i, _len, _ref, _ref1;
    if (field = _this.elements.item(index)) {
      value = null;
      if (!field.getAttribute("disabled") && (name = field.getAttribute("name"))) {
        if (field.nodeName === "SELECT") {
          selected = [];
          _ref = field.options;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            option = _ref[_i];
            if (option.selected) {
              selected.push(option.value);
            }
          }
          if (field.multiple) {
            params.push([name, selected]);
          } else {
            if (selected.length > 0) {
              value = selected[0];
            } else {
              value = (_ref1 = field.options[0]) != null ? _ref1.value : void 0;
            }
            params.push([name, value]);
          }
        } else if (field.nodeName === "INPUT" && (field.type === "checkbox" || field.type === "radio")) {
          if (field.checked) {
            params.push([name, field.value || "1"]);
          }
        } else if (field.nodeName === "INPUT" && field.type === "file") {
          if (field.value) {
            params.push([name, UploadedFile(field.value)]);
          }
        } else if (field.nodeName === "TEXTAREA" || field.nodeName === "INPUT") {
          if (field.type !== "submit" && field.type !== "image") {
            params.push([name, field.value || ""]);
          }
        }
      }
      return process(index + 1);
    } else {
      if (button && button.name) {
        params.push([button.name, button.value]);
      }
      history = document.parentWindow.history;
      return history._submit(_this.getAttribute("action"), _this.getAttribute("method"), params, _this.getAttribute("enctype"));
    }
  };
  return process(0);
};

HTML.HTMLFormElement.prototype.reset = function() {
  var field, option, _i, _len, _ref, _results;
  _ref = this.elements;
  _results = [];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    field = _ref[_i];
    if (field.nodeName === "SELECT") {
      _results.push((function() {
        var _j, _len1, _ref1, _results1;
        _ref1 = field.options;
        _results1 = [];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          option = _ref1[_j];
          _results1.push(option.selected = option._defaultSelected);
        }
        return _results1;
      })());
    } else if (field.nodeName === "INPUT" && field.type === "check" || field.type === "radio") {
      _results.push(field.checked = field._defaultChecked);
    } else if (field.nodeName === "INPUT" || field.nodeName === "TEXTAREA") {
      _results.push(field.value = field._defaultValue);
    } else {
      _results.push(void 0);
    }
  }
  return _results;
};

HTML.HTMLFormElement.prototype._dispatchSubmitEvent = function(button) {
  var event;
  event = this.ownerDocument.createEvent("HTMLEvents");
  event.initEvent("submit", true, true);
  event._button = button;
  return this.ownerDocument.parentWindow.browser.dispatchEvent(this, event);
};

HTML.HTMLFormElement.prototype._eventDefaults["submit"] = function(event) {
  return event.target.submit(event._button);
};

HTML.HTMLInputElement.prototype._eventDefaults = {
  click: function(event) {
    var change, form, input;
    input = event.target;
    change = function() {
      event = input.ownerDocument.createEvent("HTMLEvents");
      event.initEvent("change", true, true);
      return input.ownerDocument.parentWindow.browser.dispatchEvent(input, event);
    };
    switch (input.type) {
      case "reset":
        if (form = input.form) {
          return form.reset();
        }
        break;
      case "submit":
      case "image":
        if (form = input.form) {
          return form._dispatchSubmitEvent(input);
        }
        break;
      case "checkbox":
        return change();
      case "radio":
        if (!input.getAttribute("readonly")) {
          input.checked = true;
          return change();
        }
    }
  }
};

HTML.HTMLInputElement.prototype.click = function() {
  var change, checked, click, original, radio, radios, _i, _j, _len, _len1,
    _this = this;
  focus(this.ownerDocument, this);
  click = function() {
    var cancelled, event;
    event = _this.ownerDocument.createEvent("HTMLEvents");
    event.initEvent("click", true, true);
    cancelled = _this.ownerDocument.parentWindow.browser.dispatchEvent(_this, event);
    return !cancelled;
  };
  change = function() {
    var event;
    event = _this.ownerDocument.createEvent("HTMLEvents");
    event.initEvent("change", true, true);
    return _this.ownerDocument.parentWindow.browser.dispatchEvent(_this, event);
  };
  switch (this.type) {
    case "checkbox":
      if (!this.getAttribute("readonly")) {
        original = this.checked;
        this.checked = !this.checked;
        if (click()) {
          change();
        } else {
          this.checked = original;
        }
      }
      break;
    case "radio":
      if (!this.getAttribute("readonly")) {
        if (this.checked) {
          click();
        } else {
          radios = this.ownerDocument.querySelectorAll(":radio[name='" + (this.getAttribute("name")) + "']", this.form);
          checked = null;
          for (_i = 0, _len = radios.length; _i < _len; _i++) {
            radio = radios[_i];
            if (radio.checked) {
              checked = radio;
              radio.checked = false;
            }
          }
          this.checked = true;
          if (click()) {
            change();
          } else {
            this.checked = false;
            for (_j = 0, _len1 = radios.length; _j < _len1; _j++) {
              radio = radios[_j];
              radio.checked = radio === checked;
            }
          }
        }
      }
      break;
    default:
      click();
  }
};

HTML.HTMLButtonElement.prototype._eventDefaults = {
  click: function(event) {
    var button, form;
    button = event.target;
    if (button.getAttribute("disabled")) {

    } else {
      form = button.form;
      if (form) {
        return form._dispatchSubmitEvent(button);
      }
    }
  }
};

HTML.Document.prototype._elementBuilders["button"] = function(doc, s) {
  var button;
  button = new HTML.HTMLButtonElement(doc, s);
  button.type || (button.type = "submit");
  return button;
};

HTML.HTMLDocument.prototype.__defineGetter__("activeElement", function() {
  return document._focused;
});

focus = function(document, element) {
  var onblur, onfocus;
  if (element !== document._focused) {
    if (document._focused) {
      onblur = document.createEvent("HTMLEvents");
      onblur.initEvent("blur", false, false);
      document._focused.dispatchEvent(onblur);
    }
    if (element) {
      onfocus = document.createEvent("HTMLEvents");
      onfocus.initEvent("focus", false, false);
      element.dispatchEvent(onfocus);
    }
    return document._focused = element;
  }
};

_ref = [HTML.HTMLInputElement, HTML.HTMLSelectElement, HTML.HTMLTextAreaElement, HTML.HTMLButtonElement, HTML.HTMLAnchorElement];
for (_i = 0, _len = _ref.length; _i < _len; _i++) {
  element = _ref[_i];
  element.prototype.focus = function() {
    return focus(this.ownerDocument, this);
  };
  element.prototype.blur = function() {
    return focus(this.ownerDocument, null);
  };
}
